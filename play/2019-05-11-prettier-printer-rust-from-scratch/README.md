## 参考

- paper <http://homepages.inf.ed.ac.uk/wadler/papers/prettier/prettier.pdf>
- JavaScript 実装 <https://github.com/prettier/prettier-printer>

## 実装状況

- 最低限の機能は実装済み
- ただし union の実装が手抜きなせいで O(N^2) になっている気がする
    - fits 関数を適用するためにレイアウトを探索するとき、各レイアウトの最初の行だけを構築すれば十分なのに、レイアウト全体を構築してしまう
    - ペーパーの参考実装は Haskell なので遅延評価のおかげでこれを防いでいる
    - 1行目が終わった時点で再帰を止めるという仕組みが必要かもしれない
- fill のような便利な機能はない
- 改行を flatten したときに ' ' になるが、場合によっては '' になってほしい
- 強制改行がほしい
- 文字列中の \n を改行として処理しなければいけない
- 行の幅の計算に unicode 文字は考慮されていない

## ノート

大まかな流れ:

- オブジェクトを文字列に変換する前に、「ドキュメント」(`Doc`)という中間表現を使う
- ドキュメントはレイアウトの集合を表している
- レイアウトの間に順序関係を定めて、最良のレイアウトを探索する
- レイアウトを文字列に変換する

ドキュメントの定義:

- ドキュメントは普通の文字列に加えて flatten, union という操作がある
- flatten はドキュメントに含まれるすべての改行を潰して1行にする
- union は2つのドキュメントから、それら表すレイアウトの集合の和集合をとったような、ドキュメントを表す
    - ただし任意のドキュメントの union を取るのではなく、一定の条件を満たすものに限る
    - x union y をするには flatten x = flatten y を満たさないといけない
        - 要するに x, y は改行の扱いが違うだけでほぼ同様のドキュメントである
    - x union y をするには m >= M でなければいけない
        - m : x が表すレイアウトの最初の行の長さの最小値
        - M : y が表すレイアウトの最初の行の長さの最大値
    - flatten, union を非公開として、使い方を制限することで条件を維持する

レイアウトの探索:

- 行の幅の最大値 width を事前に与える
- 現在の行の幅と字下げの深さを維持しながらドキュメントをレイアウトに変換していく
- x union y において x の最良のレイアウトが現在の行に fit するなら、それを選ぶ
    - 不変条件から、x の最良のレイアウトより優れたレイアウトは y に存在しない
    - fit しないなら y を選ぶ

## 感想

- ペーパーの参考実装は読みやすい
- 効率を上げるために再帰や遅延評価を利用しない実装にしようとするとかなり複雑になる (prettier の実装を参照)
- 行の幅だけでなく密度や統一感も基準に改行した方がいいかもしれない
